{% extends 'base.html' %}
{% block title %}å­¦ç¿’è¨˜éŒ²ã®è©³ç´°{% endblock %}
{% block content %}

<div class="container py-5">
    <div class="text-center mb-4">
        <h2 class="mb-4">å­¦ç¿’è¨˜éŒ²ã®è©³ç´°</h2>
    </div>

    <!-- -------------------------------------------------------- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã®é–‹å§‹-------------------------------------------------------- -->
    <div class="card mb-4 shadow-sm" id="post-{{ post.id }}">
        
        <!--  ---------------------------------â—1. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨æ—¥ä»˜ï¼‰ --------------------------------- -->
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary">{{ post.title }}</h5>
            <small class="text-muted">{{ post.created_at.strftime('%Y/%m/%d %H:%M') }}</small>
        </div>
        
        {# é–‹ç™ºè€…ç”¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ #}
        <!--  --------------------------------- â—ãƒœãƒ‡ã‚£ãƒ¼(start)------------------------------------------------------ -->
        <!--  --------------------------------- â—ãƒ¡ã‚¤ãƒ³æƒ…å ±     ------------------------------------------------------ -->
        <!--  --------------------------------- â—æŠ•ç¨¿å†…å®¹ã‚„ãƒªãƒ³ã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³--------------------------------------------- -->
       <div class="card-body">
            <!-- ------------(2. å­¦ç¿’ã®ãƒ¡ãƒ¢å†…å®¹)------------ -->
            <p class="card-text" style="white-space: pre-wrap;">{{ post.content }}</p>
            
            <!-- ------------(3. å­¦ç¿’ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨æ™‚é–“)------------ -->
            <div class="mb-3">
                {% for detail in post.details %}
                <span class="badge bg-primary rounded-pill p-2">
                    {{ detail.category.name }}: {{ detail.duration_minutes }}åˆ†
                </span>
                {% endfor %}
            </div>

            <!-- ------------(4. å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³)------------ -->
            {% if post.references %}
            <div class="mt-3 p-3 bg-light rounded">
                <h6 class="fw-bold border-bottom pb-2">ğŸ“š å‚ç…§è³‡æ–™</h6>
                {% for ref in post.references %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>
                            {% if ref.url %}
                                <a href="{{ ref.url }}" target="_blank">{{ ref.title }}</a>
                            {% else %}
                                {{ ref.title }}
                            {% endif %}
                        </strong>
                        <span class="text-warning">
                            {{ 'â˜…' * ref.rating }}{{ 'â˜†' * (5 - ref.rating) }}
                        </span>
                    </div>
                    
                    <div class="mt-1">
                                     {% if ref.category %}
                                         <small class="text-muted">#{{ ref.category.name }}</small>
                                     {% else %}
                                         <!-- --------ã‚«ãƒ†ã‚´ãƒªãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã«å‚™ãˆã¦ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
                                         <small class="text-muted text-danger">#ã‚«ãƒ†ã‚´ãƒªãªã—</small>
                                     {% endif %}
                    </div>
                    
                </div>
                {% endfor %}
            </div>
            {% endif %}

        <!-- ------------(5. ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³)------------ -->
        <div class="d-flex justify-content-end mt-4 gap-2">
            {% if current_user.is_authenticated and current_user.id == post.user_id %}
                <!--  ------------- â˜…â˜…â˜…python å‡¦ç†æŒ‡å®š â˜…â˜…â˜…----ç·¨é›†ã¯ã€GET å‡¦ç†ã®ã¿ -------------------------------- -->
                <a href="/{{ post.id }}/update" class="btn btn-success btn-sm me-2">ç·¨é›†</a>
                <!--  ------------- â˜…â˜…â˜…python å‡¦ç†æŒ‡å®š â˜…â˜…â˜…------å‰Šé™¤ã¯ POST å‡¦ç†ãŒå¿…è¦ ------------------------------ -->
                <form action="/{{ post.id }}/delete" method="POST" onsubmit="return confirm('æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                    <button type="submit" class="btn btn-danger btn-sm">å‰Šé™¤</button>
                </form>
            {% endif %}
        </div>

        <!--  --------------------------------- â—ãƒœãƒ‡ã‚£ãƒ¼(end)------------------------------------------------------ -->

        <!--  --------------------------------- â—ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¼------------------------------------------------------ -->
        <!--  --------------------------------- â—ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æƒ…å ±-------------------------------------------------- -->
        <!-- 6. ã„ã„ã­æ©Ÿèƒ½ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼1ï¼‰ -->

        <div class="card-footer bg-white border-top-0">
            <button class="btn btn-outline-danger btn-sm like-button" 
                    data-post-id="{{ post.id }}"
                    id="like-btn-{{ post.id }}">
                <i class="bi {% if current_user.id in post.likes|map(attribute='user_id') %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                <span class="like-count">{{ post.likes.count() }}</span>
            </button>
        </div>

        <!-- 7. ã‚³ãƒ¡ãƒ³ãƒˆã‚¨ãƒªã‚¢ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼2ï¼‰ -->
        <div class="card-footer bg-light border-top">
            <h6 class="border-bottom pb-2">ã‚³ãƒ¡ãƒ³ãƒˆ ({{ post.comments.count() }})</h6>
            {% if post.comments %}
                {% for comment in post.comments %}
                <div class="mb-2 p-2 bg-white border rounded">
                    <small class="text-primary fw-bold">{{ comment.author.username }}</small>
                    <p class="mb-0">{{ comment.content }}</p>
                    <small class="text-muted d-block text-end">{{ comment.created_at.strftime('%Y/%m/%d %H:%M') }}</small>
                </div>
                {% endfor %}
            {% else %}
                <p><small class="text-muted">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</small></p>
            {% endif %}

            {% if current_user.is_authenticated %}
            <!--  ------------- â˜…â˜…â˜…python å‡¦ç†æŒ‡å®š â˜…â˜…â˜…------------------------------------ -->
            <form action="/{{ post.id }}/comment" method="POST" class="mt-3">
                <div class="input-group">
                    <input type="text" name="content" class="form-control form-control-sm" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">
                    <button class="btn btn-primary btn-sm" type="submit">æŠ•ç¨¿</button>
                </div>
            </form>
            {% endif %}
        </div>

        <!-- 8. æŠ•ç¨¿è€…æƒ…å ±ï¼ˆãƒ•ãƒƒã‚¿ãƒ¼3ï¼‰ -->
        <div class="card-footer bg-transparent text-end border-0">
            <small class="text-muted">æŠ•ç¨¿è€… : {{ post.author.username }}</small>
        </div>
    </div>
    <!-- -------------------------------------------------------- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ã®çµ‚äº†-------------------------------------------------------- -->
</div>
<script src="{{ url_for('static', filename='js/readmore.js') }}"></script>
{% endblock %}
